# PKgame コンソール版ペナルティキック 仕様（Main.java）

## 概要
- コンソール上で進行する PK（ペナルティキック）ゲーム。
- プレイヤーと AI が交互にキッカーとキーパーを担当する。
- 5 本の通常ラウンドで決着しなければサドンデスに移行。
- 入力はキーボードの特定キー（数字・英字・カンマ）から 1 文字を選ぶ。

## キー配置
- 有効キーは 4 行の配列で定義される。
  - 1 行目: `3456789`
  - 2 行目: `wertyuio`
  - 3 行目: `sdfghjkl`
  - 4 行目: `xcvbnm,`
- それぞれのキーは座標（行・列）を持ち、シュート位置やセーブ判定に使われる。

## 役割と進行
1. プレイヤーがシュートキーを入力
2. AI がキーパーキーを選択
3. 結果判定（ゴール / セーブ / バー）
4. アニメーション表示とスコア更新
5. AI がシュート、プレイヤーがキーパー入力
6. 結果判定、アニメーション、スコア更新
- 上記を 1 ラウンドとして最大 5 ラウンド行う。
- 途中で勝敗が確定した場合は早期終了する。
- 同点の場合はサドンデス（1 本ずつの延長戦）を繰り返し、差がついた時点で終了。

## 入力チェック
- 入力は 1 文字のみを受け付け、無効キーは再入力を要求。
- 入力が `null` の場合はプログラム終了。

## 判定ルール
### セーブ判定
- キーパーのキーを中心に以下 7 点が「セーブ範囲」:
  - 中心、左右、上左、上右、下左、下、下右
- シュートキーがセーブ範囲に含まれる場合はセーブ。

### バー判定
- シュートキーが「バー位置」にある場合、1/3 の確率でバー判定。
- バー位置:
  - 1 行目はすべてバー
  - 2,3 行目は左右端
  - 4 行目は左右端

### ゴール判定
- バーでもセーブでもない場合はゴール。

## AI の行動
### AI キーパー
- ε-greedy 戦略。
- ε の確率でランダム選択。
- それ以外はプレイヤーの過去シュート分布から「最も止められそうなキー」を選ぶ。
- 評価は各キーパーキーのセーブ範囲に含まれるシュート回数の合計。

### AI シュート
- ε-greedy 戦略。
- ε の確率でランダム選択。
- それ以外はプレイヤーの過去キーパー選択から「最も止められにくいキー」を選ぶ。
- 各シュートキーについて、止められた確率が最小になるキー群から選択。

### ε（探索率）
- `ε = 0.30 - 0.005 * (totalShots + totalKeeps)`
- 最小値は 0.05 に固定。

## スコアと早期決着
- 5 本の通常ラウンド中、残り本数で逆転不可能になった時点で勝敗確定。

## サドンデス
- 5 本終了時点で同点なら突入。
- 1 本ずつ交互に蹴り、差がついた時点で勝敗確定。

## 画面表示
- ゴール枠を ASCII アートで描画。
- ボールは 10 フレームで移動する簡易アニメーション。
- セーブ（キャッチ）時は停止演出を追加。
- スコアボードを表形式で表示:
  - `P`（プレイヤー）と `AI` の結果履歴
  - `O` = ゴール, `X` = 失敗（セーブ/バー）

## コメント表示
- 状況に応じたコメントをランダムに出力。
- 連続で同じコメントが出ないよう直近 10 件を記憶。
- コメントのカテゴリ:
  - 通常 / プレッシャー / トレンド偏り / トレンド散らし / AI 学習感
  - ゴール / セーブ（キャッチ）/ セーブ（はじき）/ バー
  - サドンデス開始 / 試合終了
- コメントはテンプレートを埋め込み (%r, %k, %p, %a, %s, %g, %z, %t) で出力。

## コメントの選定ロジック
- サドンデス中は常に「プレッシャー」カテゴリを使用。
- 通常時は以下の優先順で決定:
  - プレッシャー判定に該当 → プレッシャー
  - トレンド判定が「偏り」 → トレンド偏り
  - トレンド判定が「散らし」 → トレンド散らし
  - AI 学習感判定に該当 → AI 学習感
  - 上記以外 → 通常

## プレッシャー判定
- 残り本数 `remaining = 5 - kicksSelf`。
- `scoreOpp > scoreSelf` かつ `(scoreOpp - scoreSelf) >= max(1, remaining - 1)` の場合にプレッシャー扱い。

## AI 学習感判定
- `epsilon <= 0.15` または `(totalShots + totalKeeps) >= 20` の場合に AI 学習感。

## トレンド判定
- 直近 3 本のプレイヤーシュートゾーンを解析。
- 2 回以上同一ゾーンなら「偏り」、そうでなければ「散らし」。
- ゾーン:
  - 左: `3 w s x`
  - 右: `9 o l ,`
  - 上: 1 行目
  - 下: 4 行目
  - 中央: 上記以外

## 再プレイ
- 試合終了後に `y/n` を入力。
- `y` で再戦、その他は終了。
